<!doctype html><html lang=en-us dir=ltr>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Best practices for building containers">
<meta name=theme-color content="#FFFFFF">
<meta name=color-scheme content="light dark"><meta property="og:title" content>
<meta property="og:description" content="Best practices for building containers">
<meta property="og:type" content="article">
<meta property="og:url" content="http://docs.cuong-dev.ml/docs/docker/best-practices-for-building-containers/"><meta property="article:section" content="docs">
<title>Best Practices for Building Containers | Cuong Blogs</title>
<link rel=manifest href=/manifest.json>
<link rel=icon href=/favicon.png type=image/x-icon>
<link rel=stylesheet href=/book.min.82c5dbd23447cee0b4c2aa3ed08ce0961faa40e1fa370eee4f8c9f02e0d46b5f.css integrity="sha256-gsXb0jRHzuC0wqo+0Izglh+qQOH6Nw7uT4yfAuDUa18=" crossorigin=anonymous>
<script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.55e0539719e72da549c7ebf2ef046042ab7866cfac8242180db8848d3f7c9be6.js integrity="sha256-VeBTlxnnLaVJx+vy7wRgQqt4Zs+sgkIYDbiEjT98m+Y=" crossorigin=anonymous></script>
</head>
<body dir=ltr>
<input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control>
<main class="container flex">
<aside class=book-menu>
<div class=book-menu-content>
<nav>
<h2 class=book-brand>
<a class="flex align-center" href=/><span>Cuong Blogs</span>
</a>
</h2>
<div class=book-search>
<input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/>
<div class="book-search-spinner hidden"></div>
<ul id=book-search-results></ul>
</div>
<ul>
<li>
<a href=/docs/about-me/>About me</a>
<ul>
</ul>
</li>
<li>
<span>Aws</span>
<ul>
<li>
<a href=/docs/aws/extend-the-file-system-of-ebs-volumes/>Extend the File System of Ebs Volumes</a>
</li>
<li>
<a href=/docs/aws/install-docker-docker-compose-on-aws-ec2/>Install Docker, Docker Compose on Aws Ec2</a>
</li>
<li>
<a href=/docs/aws/install-cert-bot-ssl-letsencrypt-on-amz-linux-2/>Install Cert Bot Ssl Letsencrypt on Amz Linux 2</a>
</li>
<li>
<a href=/docs/aws/mount-new-ebs-volume-to-aws-ec2/>Mount New Ebs Volume to Aws Ec2</a>
</li>
<li>
<a href=/docs/aws/setting-swap-ec2/>Setting Swap Ec2</a>
</li>
</ul>
</li>
<li>
<span>Azure</span>
<ul>
<li>
<a href=/docs/azure/azure-2/>Azure 2</a>
</li>
<li>
<a href=/docs/azure/azure-new-service-update/>Azure New Service Update</a>
</li>
<li>
<a href=/docs/azure/untitled-3/>Untitled 3</a>
</li>
<li>
<a href=/docs/azure/untitled-copy/>Untitled Copy</a>
</li>
<li>
<a href=/docs/azure/untitled/>Untitled</a>
</li>
</ul>
</li>
<li>
<span>Cheatsheet</span>
<ul>
<li>
<a href=/docs/cheatsheet/bash/>Bash</a>
</li>
<li>
<a href=/docs/cheatsheet/docker-cheatsheet/>Docker Cheatsheet</a>
</li>
<li>
<a href=/docs/cheatsheet/grep/>Grep</a>
</li>
</ul>
</li>
<li>
<span>Databases</span>
<ul>
<li>
<a href=/docs/databases/general-table-size-information/>General Table Size Information</a>
</li>
<li>
<a href=/docs/databases/install-postgres-client-amazon-linux-1/>Install Postgres Client Amazon Linux 1</a>
</li>
<li>
<a href=/docs/databases/postgres-create-user-and-grant-permistions/>Postgres Create User and Grant Permistions</a>
</li>
</ul>
</li>
<li>
<span>Docker</span>
<ul>
<li>
<a href=/docs/docker/best-practices-for-building-containers/ class=active>Best Practices for Building Containers</a>
</li>
<li>
<a href=/docs/docker/checking-file-when-build-docker/>Checking File When Build Docker</a>
</li>
<li>
<a href=/docs/docker/disstroless-docker-image/>Disstroless Docker Image</a>
</li>
<li>
<a href=/docs/docker/docker-how-to-cleanup-unused-resources/>Docker How to Cleanup Unused Resources</a>
</li>
<li>
<a href=/docs/docker/quick-install-docker/>Quick Install Docker</a>
</li>
<li>
<a href=/docs/docker/remove-unused-docker-resource/>Remove Unused Docker Resource</a>
</li>
</ul>
</li>
<li>
<span>Gcp</span>
<ul>
<li>
<a href=/docs/gcp/mistakes-to-avoid-when-using-google-cloud/>Mistakes to Avoid When Using Google Cloud</a>
</li>
<li>
<a href=/docs/gcp/untitled/>Untitled</a>
</li>
</ul>
</li>
<li>
<span>Jenkins</span>
<ul>
<li>
<a href=/docs/jenkins/jenkins-deploy-aws-ecs/>Jenkins Deploy Aws Ecs</a>
</li>
<li>
<a href=/docs/jenkins/jenkins-fix-report-cannot-view-on-browser/>Jenkins Fix Report Cannot View on Browser</a>
</li>
</ul>
</li>
<li>
<span>K8s</span>
<ul>
<li>
<a href=/docs/k8s/kubectl-tips-and-tricks/>Kubectl Tips and Tricks</a>
</li>
<li>
<a href=/docs/k8s/linkerd-cheatsheet/>Linkerd Cheatsheet</a>
</li>
</ul>
</li>
<li>
<span>Linux</span>
<ul>
<li>
<a href=/docs/linux/check-ssl-certificate-expiration-date-s/>Check Ssl Certificate Expiration Date S</a>
</li>
<li>
<a href=/docs/linux/dynamic-port-mapping-for-access-ftp-server/>Dynamic Port Mapping for Access FTP Server</a>
</li>
<li>
<a href=/docs/linux/print-all-duplicated/>Print All Duplicated</a>
</li>
<li>
<a href=/docs/linux/quick-load-.env-file/>Quick Load .Env File</a>
</li>
<li>
<a href=/docs/linux/writing-bash-shell-scripts-best-practice/>Writing Bash Shell Scripts Best Practice</a>
</li>
</ul>
</li>
<li>
<span>Monitoring</span>
<ul>
<li>
<a href=/docs/monitoring/alert-manager/>Alert Manager</a>
</li>
<li>
<a href=/docs/monitoring/install-node_exporter-as-systemd/>Install Node Exporter as Systemd</a>
</li>
</ul>
</li>
<li>
<span>Others</span>
<ul>
<li>
<a href=/docs/others/alert-slack-by-hook/>Alert Slack by Hook</a>
</li>
<li>
<a href=/docs/others/install-redmine-on-centos-7/>Install Redmine on Centos 7</a>
</li>
</ul>
</li>
</ul>
<ul>
<li>
<a href=/posts/>
Blogs
</a>
</li>
</ul>
</nav>
<script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>
</div>
</aside>
<div class=book-page>
<header class=book-header>
<div class="flex align-center justify-between">
<label for=menu-control>
<img src=/svg/menu.svg class=book-icon alt=Menu>
</label>
<strong>Best Practices for Building Containers</strong>
<label for=toc-control>
<img src=/svg/toc.svg class=book-icon alt="Table of Contents">
</label>
</div>
<aside class="hidden clearfix">
<nav id=TableOfContents>
<ul>
<li>
<ul>
<li><a href=#dockerfile-tips-and-tricks>Dockerfile tips and tricks</a></li>
</ul>
</li>
</ul>
</nav>
</aside>
</header>
<article class=markdown><h1 id=best-practices-for-building-containers>
Best practices for building containers
<a class=anchor href=#best-practices-for-building-containers>#</a>
</h1>
<h3 id=dockerfile-tips-and-tricks>
Dockerfile tips and tricks
<a class=anchor href=#dockerfile-tips-and-tricks>#</a>
</h3>
<p>Consider the example below.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ae81ff>FROM debian</span>

<span style=color:#75715e># Copy application files</span>
<span style=color:#ae81ff>COPY . /app</span>

<span style=color:#75715e># Install required system packages</span>
<span style=color:#ae81ff>RUN apt-get update</span>
<span style=color:#ae81ff>RUN apt-get -y install imagemagick curl software-properties-common gnupg vim ssh</span>
<span style=color:#ae81ff>RUN curl -sL https://deb.nodesource.com/setup_10.x | bash -</span>
<span style=color:#ae81ff>RUN apt-get -y install nodejs</span>

<span style=color:#75715e># Install NPM dependencies</span>
<span style=color:#ae81ff>RUN npm install --prefix /app</span>
<span style=color:#ae81ff>EXPOSE 80</span>
<span style=color:#ae81ff>CMD [&#34;npm&#34;, &#34;start&#34;, &#34;--prefix&#34;, &#34;app&#34;]</span>
</code></pre></div><p>It takes <strong>127.8 seconds</strong> to build the image and it is <strong>554MB</strong>. Let&rsquo;s improve this result by following some good practices!!</p>
<h4 id=1--order-matters-for-caching>
1- Order matters for caching
<a class=anchor href=#1--order-matters-for-caching>#</a>
</h4>
<p>The least frequently changing statements should be appear first. This is because when you change or modify a line in the dockerfile and its cache gets invalidated, the subsequent line will break due to these changes. Hence, you need to keep the most frequently changing lines as last as possible.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ae81ff>FROM debian</span>

<span style=color:#75715e># Install required system packages</span>
<span style=color:#ae81ff>RUN apt-get update</span>
<span style=color:#ae81ff>RUN apt-get -y install imagemagick curl software-properties-common gnupg vim ssh</span>
<span style=color:#ae81ff>RUN curl -sL https://deb.nodesource.com/setup_10.x | bash -</span>
<span style=color:#ae81ff>RUN apt-get -y install nodejs</span>

<span style=color:#75715e># Copy application files</span>
<span style=color:#ae81ff>COPY . /app</span>

<span style=color:#75715e># Install NPM dependencies</span>
<span style=color:#ae81ff>RUN npm install --prefix /app</span>
<span style=color:#ae81ff>EXPOSE 80</span>
<span style=color:#ae81ff>CMD [&#34;npm&#34;, &#34;start&#34;, &#34;--prefix&#34;, &#34;app&#34;]</span>
</code></pre></div><p>Rebuild the image using the same command, but avoiding the installation of the system packages. This is the result: it takes <strong>5.8 seconds</strong> to build!! The improvement is huge!!</p>
<h4 id=2--you-should-be-more-specific-about-the-files-you-copy-to-make-sure-that-you-are-not-invalidating-the-cache-with-changes-that-do-not-affect-the-application>
2- ****You <strong>should be more specific about the files you copy</strong> to make sure that you are not invalidating the cache with changes that do not affect the application.
<a class=anchor href=#2--you-should-be-more-specific-about-the-files-you-copy-to-make-sure-that-you-are-not-invalidating-the-cache-with-changes-that-do-not-affect-the-application>#</a>
</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ae81ff>FROM debian</span>

<span style=color:#75715e># Install required system packages</span>
<span style=color:#ae81ff>RUN apt-get update</span>
<span style=color:#ae81ff>RUN apt-get -y install imagemagick curl software-properties-common gnupg vim ssh</span>
<span style=color:#ae81ff>RUN curl -sL https://deb.nodesource.com/setup_10.x | bash -</span>
<span style=color:#ae81ff>RUN apt-get -y install nodejs</span>

<span style=color:#75715e># Copy application files</span>
<span style=color:#ae81ff>COPY package.json server.js /app</span>

<span style=color:#75715e># Install NPM dependencies</span>
<span style=color:#ae81ff>RUN npm install --prefix /app</span>
<span style=color:#ae81ff>EXPOSE 80</span>
<span style=color:#ae81ff>CMD [&#34;npm&#34;, &#34;start&#34;, &#34;--prefix&#34;, &#34;app&#34;]</span>
</code></pre></div><blockquote>
<p>NOTE: Use &ldquo;COPY&rdquo; instead of &ldquo;ADD&rdquo; when possible. Both commands do basically the same thing, but &ldquo;ADD&rdquo; is more complex: it has extra features like extracting files or copying them from remote sources. From a security perspective too, using &ldquo;ADD&rdquo; increases the risk of malware injection in your image if the remote source you are using is unverified or insecure.</p>
</blockquote>
<h4 id=3--avoiding-packaging-dependencies-that-you-do-not-need>
3- Avoiding packaging dependencies that you do not need
<a class=anchor href=#3--avoiding-packaging-dependencies-that-you-do-not-need>#</a>
</h4>
<p>The current Dockerfile includes the <strong>ssh</strong> system package. However, you can access your containers using the <code>docker exec</code> command instead of ssh&rsquo;ing into them. Apart from that, it also includes <strong>vim</strong> for debugging purposes, which can be installed when required, instead of packaged by default. Both packages are removable from the image.</p>
<p>In addition, you can configure the package manager to avoid installing packages that you don&rsquo;t need. To do so, use the <code>--no-install-recommends</code> flag on your <code>apt-get</code> calls:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ae81ff>FROM debian</span>

<span style=color:#75715e># Install required system packages</span>
<span style=color:#ae81ff>RUN apt-get update</span>
<span style=color:#ae81ff>RUN apt-get -y install --no-install-recommends imagemagick curl software-properties-common gnupg</span>
<span style=color:#ae81ff>RUN curl -sL https://deb.nodesource.com/setup_10.x | bash -</span>
<span style=color:#ae81ff>RUN apt-get -y install --no-install-recommends nodejs</span>

<span style=color:#75715e># Copy application files</span>
<span style=color:#ae81ff>COPY package.json server.js /app</span>

<span style=color:#75715e># Install NPM dependencies</span>
<span style=color:#ae81ff>RUN npm install --prefix /app</span>
<span style=color:#ae81ff>EXPOSE 80</span>
<span style=color:#ae81ff>CMD [&#34;npm&#34;, &#34;start&#34;, &#34;--prefix&#34;, &#34;app&#34;]</span>
</code></pre></div><h4 id=4--try-to-chain-all-the-cacheable-units>
4- Try to chain all the cacheable units.
<a class=anchor href=#4--try-to-chain-all-the-cacheable-units>#</a>
</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ae81ff>FROM debian</span>

<span style=color:#75715e># Install required system packages</span>
<span style=color:#ae81ff>RUN apt-get update &amp;&amp; apt-get -y install --no-install-recommends imagemagick curl software-properties-common gnupg \</span>
 <span style=color:#75715e>&amp;&amp;</span> <span style=color:#ae81ff>curl -sL https://deb.nodesource.com/setup_10.x | bash - </span>
 <span style=color:#75715e>&amp;&amp;</span> <span style=color:#ae81ff>apt-get -y install --no-install-recommends nodejs</span>

<span style=color:#75715e># Copy application files</span>
<span style=color:#ae81ff>COPY package.json server.js /app</span>

<span style=color:#75715e># Install NPM dependencies</span>
<span style=color:#ae81ff>RUN npm install --prefix /app</span>
<span style=color:#ae81ff>EXPOSE 80</span>
<span style=color:#ae81ff>CMD [&#34;npm&#34;, &#34;start&#34;, &#34;--prefix&#34;, &#34;app&#34;]</span>
</code></pre></div><h4 id=5--finally-remove-the-package-manager-cache-to-reduce-the-image-size>
5- Finally, remove the package manager cache to reduce the image size
<a class=anchor href=#5--finally-remove-the-package-manager-cache-to-reduce-the-image-size>#</a>
</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#ae81ff>FROM debian</span>

<span style=color:#75715e># Install required system packages</span>
<span style=color:#ae81ff>RUN apt-get update &amp;&amp; apt-get -y install --no-install-recommends imagemagick curl software-properties-common gnupg \</span>
 <span style=color:#75715e>&amp;&amp;</span> <span style=color:#ae81ff>curl -sL https://deb.nodesource.com/setup_10.x | bash - </span>
 <span style=color:#75715e>&amp;&amp;</span> <span style=color:#ae81ff>apt-get -y install --no-install-recommends nodejs </span>
 <span style=color:#75715e>&amp;&amp;</span> <span style=color:#ae81ff>rm -rf /var/lib/apt/lists/*</span>

<span style=color:#75715e># Copy application files</span>
<span style=color:#ae81ff>COPY package.json server.js /app</span>

<span style=color:#75715e># Install NPM dependencies</span>
<span style=color:#ae81ff>RUN npm install --prefix /app</span>
<span style=color:#ae81ff>EXPOSE 80</span>
<span style=color:#ae81ff>CMD [&#34;npm&#34;, &#34;start&#34;, &#34;--prefix&#34;, &#34;app&#34;]</span>
</code></pre></div><p>If you rebuild the image again…</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>$ docker build . -t express-image:0.0.3
</code></pre></div><p>… The image was reduced to <strong>340MB!!</strong> That&rsquo;s almost half of its original size.</p>
</article>
<footer class=book-footer>
<div class="flex flex-wrap justify-between">
</div>
<script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>
</footer>
<div class=book-comments>
</div>
<label for=menu-control class="hidden book-menu-overlay"></label>
</div>
<aside class=book-toc>
<div class=book-toc-content>
<nav id=TableOfContents>
<ul>
<li>
<ul>
<li><a href=#dockerfile-tips-and-tricks>Dockerfile tips and tricks</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</aside>
</main>
</body>
</html>